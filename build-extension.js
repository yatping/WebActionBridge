const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Define directories
const clientDir = path.join(__dirname, 'client');
const distDir = path.join(__dirname, 'dist');
const extensionDir = path.join(distDir, 'extension');

// Create the extension directory if it doesn't exist
if (!fs.existsSync(extensionDir)) {
  fs.mkdirSync(extensionDir, { recursive: true });
}

// Build the React application for production
console.log('Building React application...');
execSync('npm run build', { stdio: 'inherit' });

// Copy the public files to the extension directory
console.log('Copying extension files...');
fs.cpSync(path.join(clientDir, 'public'), extensionDir, { recursive: true });

// Copy the built files to the extension directory
fs.cpSync(path.join(distDir, 'public'), extensionDir, { recursive: true });

// Create a simple popup.js file that loads the main bundle
const popupJsContent = `
// This script is generated by the build process
document.addEventListener('DOMContentLoaded', function() {
  // Import the main bundle
  const script = document.createElement('script');
  script.src = './assets/index.js';
  script.type = 'module';
  document.body.appendChild(script);
});
`;

fs.writeFileSync(path.join(extensionDir, 'popup.js'), popupJsContent);

console.log('Extension build complete! Files are in the dist/extension directory.');